services:
  flask_app:
    build:
      context: .  # Diretório atual
      dockerfile: Dockerfile
    ports:
      - "80:80"  # Porta mapeada para o Flask
    volumes:
      - .:/app  # Monta o diretório local no container
    environment:
      - FLASK_ENV=development  # Ambiente de desenvolvimento
      - MQTT_BROKER=mosquitto  # Nome do serviço do Mosquitto
      - MYSQL_HOST=mysql  # Nome do serviço MySQL
      - MYSQL_PORT=3306  # Porta padrão do MySQL
      - MYSQL_USER=root  # Usuário MySQL
      - MYSQL_PASSWORD=example  # Senha do MySQL
      - MYSQL_DATABASE=weather_data  # Nome do banco de dados
    depends_on:
      - mysql  # Dependência do MySQL
      - mosquitto  # Dependência do Mosquitto
    command: python app.py  # Comando para executar a aplicação

  mosquitto:
    image: eclipse-mosquitto:latest  # Imagem oficial do Mosquitto
    container_name: mosquitto-broker  # Nome do container
    ports:
      - "1883:1883"  # Porta MQTT
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf  # Configuração do Mosquitto
      - ./data:/mosquitto/data  # Persistência de dados
      - ./log:/mosquitto/log  # Persistência de logs
    restart: always  # Reiniciar automaticamente

  mysql:
    image: mysql:8.0  # Imagem oficial do MySQL
    container_name: mysql-database  # Nome do container
    environment:
      MYSQL_ROOT_PASSWORD: example  # Senha root do MySQL
      MYSQL_DATABASE: weather_data  # Nome do banco de dados
    ports:
      - "3306:3306"  # Porta para acesso externo
    volumes:
      - mysql_data:/var/lib/mysql  # Persistência de dados
      - ./tabela.sql:/docker-entrypoint-initdb.d/tabela.sql  # Script para criar a tabela

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: phpmyadminN 
    environment:
      PMA_HOST: mysql  # Nome do serviço MySQL no Docker Compose
      PMA_PORT: 3306
      MYSQL_ROOT_PASSWORD: example  # Deve ser igual ao configurado no MySQL
    ports:
      - "8000:80"  # Porta para acessar o phpMyAdmin no navegador
    depends_on:
      - mysql

volumes:
  mysql_data:
    driver: local  # Volume para persistência do banco de dados